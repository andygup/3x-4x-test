<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>MapView</title>

  <link rel="stylesheet" href="https://jsdev.arcgis.com/4.14/esri/css/main.css"/>
    <script src="https://jsdev.arcgis.com/4.14/"></script>

  <style>
    
    html, body, #mapDiv {
      padding: 0;
      margin: 0;
      width: 100%;
      height: 100%;
    }
    #info {
      position: absolute;
      background: #ffffff;
      border: 1px solid grey;
      margin: 0;
      padding: 4px;
      left: 56px;
      top: 15px;
    }
    #timeinfo {
      position: absolute;
      background: #ffffff;
      border: 1px solid grey;
      margin: 0;
      padding: 4px;
      left: 56px;
      top: 50px;
    }    
  
  </style>

  <script>
        let counts = 0;
    let round = 1;

    require([
      "esri/Map",
      "esri/geometry/Extent",
      "esri/views/MapView",
      "esri/layers/CSVLayer",
    ], function (
        Map,
        Extent,
        MapView,
        CSVLayer
    ) {

   window.addEventListener('load', function () {
      console.log("Loaded at", new Date().toString()); 
     
      var starttime = performance.now();
      sessionStorage.setItem('good_exit', 'pending');
      
      sessionStorage.setItem('start_time', new Date().toString());
      // log status every 10 seconds
      setInterval(function () {
        var sec_num = parseInt(performance.now()/1000, 10); // don't forget the second param
        var hours   = Math.floor(sec_num / 3600);
        var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
        var seconds = sec_num - (hours * 3600) - (minutes * 60);
        if (hours   < 10) {hours   = "0"+hours;}
        if (minutes < 10) {minutes = "0"+minutes;}
        if (seconds < 10) {seconds = "0"+seconds;}        
        var timestring = hours + ':' + minutes + ':' + seconds;
        console.log(counts + " locations in " + sec_num + " seconds which is " + timestring);
        timeinfo.innerHTML = "Running time: " + timestring;
      }, 1000);

     // setInterval(function () {
     //    sessionStorage.setItem('time_before_crash', new Date().toString());
     //    sessionStorage.setItem('counts', counts);
     //    var sec_num = parseInt(performance.now()/1000, 10); // don't forget the second param
     //    var hours   = Math.floor(sec_num / 3600);
     //    var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
     //    var seconds = sec_num - (hours * 3600) - (minutes * 60);
     //    // console.log(hours, minutes, seconds);
     //    sessionStorage.setItem('running_time', hours + " hours " + minutes + " minutes and " + seconds + " seconds");
     //  }, 1000);
   });

   window.addEventListener('beforeunload', function () {
      sessionStorage.setItem('good_exit', 'true');
      sessionStorage.setItem('beforeunload-random', 'Does it do "beforeunload" when crashing?');
   });

   window.addEventListener('unload', function () {
      sessionStorage.setItem('unload', 'Does it do "unload" when crashing?');
      sessionStorage.setItem('unload-time', new Date().toString());
   });
      
   // if(sessionStorage.getItem('good_exit') &&
   //    sessionStorage.getItem('good_exit') !== 'true') {
   //    alert('Hey, welcome back from your crash, looks like you crashed on:\n'
   //          + sessionStorage.getItem('time_before_crash')
   //          + "\n in the app that started on\n"
   //          + sessionStorage.getItem('start_time')
   //          + "\n so it ran for a total of\n"
   //          + sessionStorage.getItem('running_time')
   //          + "\n for this many actions\n"
   //          + sessionStorage.getItem('counts')
   //         );
   //    }
      
      var points = [        
          [10, 15],
          [20, 25],
          [30, 35],
          [40, 45],
          [90, 45],
          [-122.4194, 37.7749],
          [-118.2437, 34.0522],
          [-117.1611, 32.7157],
          [-74.0059, 40.7128],
          [-79.3832, 43.6532],
          [-96.7970, 32.7767],
          [-99.1332, 19.4326],
          [72.8777, 19.0760],
          [67.0099, 24.8615],
          [139.6917, 35.6895],
          [-90, 45],
          [50, 55],
          [60, 15],
          [70, 25],
          [80, 35],
          [15, 65],
          [25, 45],
      ];

      var locations = [];

      for (let i = 1; i < points.length; ++i) {
        var p0 = points[i - 1];
        var p1 = points[i];

        var delta = Math.max(Math.abs(p0[0] - p1[0]), Math.abs(p0[1] - p1[1]));
        var deltaZ = 10 - delta / 12;
        if (deltaZ < 0) {
          // console.log('Bad zoom level!');
        }
        var pAvg = [(p0[0] + p1[0]) / 2, (p0[1] + p1[1]) / 2];

        locations.push({ center: p0, zoom: 7 });
        locations.push({ center: pAvg, zoom: deltaZ });
      }

      const url =
        "./allquakes.csv";

      layer = new CSVLayer({
        title: "Hurricanes",
        url: url,
        copyright: "NOAA",
        renderer: {
          type: "simple",
          symbol: {
            type: "simple-marker",  // autocasts as new SimpleMarkerSymbol()
            color: "orange",
            size: "6px",  // pixels
            outline: {  // autocasts as new SimpleLineSymbol()
              color: "gray",
              width: 0.75
            }
          }
        }
      });

      map = new Map({
        basemap: "dark-gray",
        layers: [layer]
      });

      view = new MapView({
        container: "mapDiv",
        map: map,
        center: locations[0].center,
        zoom: locations[0].zoom,
        //constraints: {
        //  snapToZoom: true
       // }
      });

      opts = {
        duration: 500,
        animate: true,
        easing: "easeOutSine"
      };

      // Tour!
      view.whenLayerView(layer).then(function () {
        let index = 0;

        function next() {
          // console.log("next", round, index, counts);
          var loc = locations[index];
          index++;
          if (index === locations.length) {
            index = 0;
            console.log("Round", round, "done.",  counts + " locations so far.");
            round++;
          }
          counts++;
          info.innerHTML = counts + ": Round " + round + " Location " + index;

          view.goTo({
            center: loc.center,
            zoom: loc.zoom
          }, opts).then(function(){
            view.goTo({
              zoom: loc.zoom*2 
            }).then(function(){
              view.goTo({
                zoom: loc.zoom/2
              }).then(next);
            });
          });
        }

        next();
      });
    });
  </script>
</head>
<body>
  <div id="mapDiv">
      <p id="info">Loading...</p>
      <p id="timeinfo"></p>
  </div>
</body>
</html>
